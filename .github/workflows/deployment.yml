name: CI/CD Pipeline with Helm

run-name: ${{ github.actor }} - ${{ github.ref_name }} - ${{ github.sha }}

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CLUSTER_NAME: todolist

jobs:
  python-ci:
    name: Python CI & Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./src
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage flake8
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python manage.py test

      - name: Generate Coverage Report
        run: |
          coverage run --source='.' manage.py test
          coverage report

      - name: Linting
        run: |
          flake8 . --show-source --statistics --exit-zero

      - name: Check Complexity
        run: |
          flake8 . --exit-zero --max-complexity=6

  helm-lint-package:
    name: Helm Lint & Package
    runs-on: ubuntu-latest
    needs: python-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Update Helm dependencies
        run: |
          cd helm-charts/todoapp
          helm dependency update

      - name: Lint Helm chart
        run: |
          helm lint helm-charts/todoapp

      - name: Template Helm chart
        run: |
          helm template todoapp helm-charts/todoapp \
            -f helm-charts/todoapp/values.yaml

      - name: Package Helm chart
        run: |
          helm package helm-charts/todoapp -d helm-packages

      - name: Upload Helm package
        uses: actions/upload-artifact@v4
        with:
          name: helm-package
          path: helm-packages/*.tgz

  deploy-development:
    name: Deploy to Development (Kind)
    runs-on: ubuntu-latest
    needs: helm-lint-package
    if: github.ref == 'refs/heads/main'
    environment:
      name: development
      url: http://localhost:30007
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          config: cluster.yml

      - name: Verify cluster
        run: |
          kubectl cluster-info --context kind-${{ env.CLUSTER_NAME }}
          kubectl get nodes

      - name: Update Helm dependencies
        run: |
          cd helm-charts/todoapp
          helm dependency update

      - name: Create secrets file
        run: |
          cat > helm-charts/secrets.yaml <<EOF
          mysql:
            secrets:
              MYSQL_ROOT_PASSWORD: "${{ secrets.MYSQL_ROOT_PASSWORD }}"
              MYSQL_USER: "${{ secrets.MYSQL_USER }}"
              MYSQL_PASSWORD: "${{ secrets.MYSQL_PASSWORD }}"
          
          todoapp:
            secrets:
              SECRET_KEY: "${{ secrets.SECRET_KEY }}"
              DB_NAME: "${{ secrets.DB_NAME }}"
              DB_USER: "${{ secrets.DB_USER }}"
              DB_PASSWORD: "${{ secrets.DB_PASSWORD }}"
              DB_HOST: "${{ secrets.DB_HOST }}"
          EOF

      - name: Deploy to Kind cluster
        run: |
          helm install todoapp helm-charts/todoapp \
            -f helm-charts/todoapp/values.yaml \
            -f helm-charts/secrets.yaml \
            --create-namespace \
            --wait \
            --timeout 5m

      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=mysql -n mysql --timeout=300s
          kubectl wait --for=condition=ready pod -l app=todoapp -n todoapp --timeout=300s

      - name: Show deployment status
        run: |
          kubectl get namespaces
          echo ""
          kubectl get pods -n mysql
          echo ""
          kubectl get pods -n todoapp
          echo ""
          kubectl get svc -n todoapp
          kubectl get svc -n mysql

      - name: Run smoke tests
        run: |
          echo "Waiting for application to be ready..."
          sleep 10
          kubectl get pods -n todoapp
          kubectl logs -n todoapp -l app=todoapp --tail=50

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-development
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: http://staging.example.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}-staging
          config: cluster.yml

      - name: Update Helm dependencies
        run: |
          cd helm-charts/todoapp
          helm dependency update

      - name: Create secrets file for staging
        run: |
          cat > helm-charts/secrets-staging.yaml <<EOF
          mysql:
            secrets:
              MYSQL_ROOT_PASSWORD: "${{ secrets.MYSQL_ROOT_PASSWORD_STAGING }}"
              MYSQL_USER: "${{ secrets.MYSQL_USER }}"
              MYSQL_PASSWORD: "${{ secrets.MYSQL_PASSWORD_STAGING }}"
          
          todoapp:
            secrets:
              SECRET_KEY: "${{ secrets.SECRET_KEY_STAGING }}"
              DB_NAME: "${{ secrets.DB_NAME }}"
              DB_USER: "${{ secrets.DB_USER }}"
              DB_PASSWORD: "${{ secrets.DB_PASSWORD_STAGING }}"
              DB_HOST: "mysql.mysql-staging.svc.cluster.local"
          EOF

      - name: Deploy to Staging
        run: |
          helm install todoapp-staging helm-charts/todoapp \
            -f helm-charts/todoapp/values.yaml \
            -f helm-charts/todoapp/values/stg.yaml \
            -f helm-charts/secrets-staging.yaml \
            --create-namespace \
            --wait \
            --timeout 5m

      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=mysql -n mysql-staging --timeout=300s
          kubectl wait --for=condition=ready pod -l app=todoapp -n todoapp-staging --timeout=300s

      - name: Show staging deployment status
        run: |
          kubectl get namespaces
          echo ""
          kubectl get pods -n mysql-staging
          echo ""
          kubectl get pods -n todoapp-staging
          echo ""
          kubectl get svc -n todoapp-staging
          kubectl get svc -n mysql-staging